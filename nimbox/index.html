
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>NIM and Squeezebox - joakimbech.com</title>
  <meta name="author" content="Joakim Bech">

  
  <meta name="description" content="NIM and Squeezebox Dec 22nd, 2013 Don&rsquo;t most of us just dislike (to say it in a nice way) all those telephony
sellers, that want to sell you &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jyx.github.io/nimbox">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="joakimbech.com" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46803417-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">joakimbech.com</a></h1>
  
    <h2>The trash can full of ideas</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jyx.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">NIM and Squeezebox</h1>
    <p class="meta">








  


<time datetime="2013-12-22T17:50:00+01:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2013</time></p>
  </header>
  
  <p>Don&rsquo;t most of us just dislike (to say it in a nice way) all those telephony
sellers, that want to sell you newspaper subscriptions, very nice insurances,
much better mobile subscriptions than the one you already have? Personally I
really like when they are calling a Friday at 19 o&#8217;clock on the evening just
when you have started to enjoy the weekend. No, as you already understand I
don&rsquo;t like it. A couple of months ago when a phone caller just had called me I
was beginning to think about how to stop this. I was surfing the net and found
a couple of different solutions for this. Everything from building the
electronics yourself to buying complete solutions. In the past I had also heard
about <a href="http://www.asterisk.org/">Asterisk</a>, but that sounded a bit complicated,
I wanted an easier solution.</p>

<p>One page that I liked was www.nim.se. They had nice little unit, simply called
nim. The nim will decode the DTMF signals to an ASCII string. I could also see
on the page that there were quite many scripts already written for the nim.
However most of the scripts was for Windows and I planned to use this on Linux
and not X86 Linux I planned to use it on my ARM-based QNAP TS-209 PROII (a NAS
which is running Linux under the hood). But I though if there isn&rsquo;t anything
that already is working, then I have a fun project in front of me.</p>

<p>So I ordered the unit and when I got it I must say that I was surprised how big
it was. Thinking about what it achieve it could be much smaller in size. I
first installed and tested it on a laptop with WinXP and it worked perfectly.
Then I wanted to try it on my QNAP. First problem, there is no COM port on the
QNAP! I had an USB to RS232 cable laying around so I connected the nim to the
QNAP using this cable. Result? Nothing happened. Why? There was no driver for
the cable which has a chip called PL2303 inside. I installed a cross compile
toolchain for ARM and downloaded source for this chip. I managed to compile the
driver for ARM and put the kernel driver on the QNAP and loaded it. I tried
with the USB to RS232 cable again and this time it worked. You can download the
required drivers here:</p>

<p><a href="/nimbox/pl2303_usb_arm.tar.gz">pl2303_usb_arm.tar.gz</a> (SHA1: 9d2f6ee563b4abfd533e0932356f3e9c340e1bf8)</p>

<p>And load the modules by typing</p>

<pre><code>insmod usbserial.ko
insmod pl2303.ko
</code></pre>

<p>Second problem! I need a modem to be able to answer and hang up calls. The QNAP
have no integrated modem and I don&rsquo;t any modem laying around. So, what should I
then do with the nim without a modem? I surfed the nim forum and found out that
there is a software called YAC client which can show incoming calls on your
computers at home. I installed this on my computers. Now I had to get some kind
of server software to run (on Linux). I found a Perl script called Phoneserver
which is written by Jan Nilsson. I tested this Perl script and indeed it
worked. The calls showed up on my computer. Nice! But could I use it to
anything else? I have a <a href="http://www.logitech.com/en-us/support/881?crid=409&amp;osid=14&amp;bit=64">Squeezebox Classic</a> at
home which I bought a couple of years ago. You can control the Squeezebox using
telnet (yes, this insecure protocol still exits). This simple BASH-script will
send the string you put as argument to the Squeezebox server, which in turns
sends it to the Squeezebox with a certain mac-address.</p>

<figure class='code'><figcaption><span>Send string to squeezebox </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#!/bin/sh</span>
</span><span class='line'><span class="n">MSG</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="mi">1</span><span class="o">|</span><span class="n">sed</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span> <span class="o">/%</span><span class="mi">20</span><span class="o">/</span><span class="n">g</span><span class="err">&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'><span class="n">echo</span> <span class="mo">00</span><span class="o">:</span><span class="mo">04</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mo">07</span><span class="o">:</span><span class="mi">3</span><span class="n">d</span><span class="o">:</span><span class="mo">00</span> <span class="n">show</span> <span class="n">line2</span><span class="o">:</span><span class="err">$</span><span class="n">MSG</span> <span class="n">font</span><span class="o">:</span><span class="n">huge</span> <span class="n">centered</span><span class="o">:</span><span class="mi">1</span> <span class="n">duration</span><span class="o">:</span><span class="mi">4</span>
</span><span class='line'><span class="n">sleep</span> <span class="mi">1</span>
</span><span class='line'><span class="n">echo</span> <span class="n">exit</span>
</span><span class='line'><span class="p">)</span> <span class="o">|</span> <span class="n">telnet</span> <span class="mf">192.168.0.196</span> <span class="mi">9090</span>
</span><span class='line'><span class="n">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, now I had a working Perl script for the nim and a bash script that could send strings to the Squeezebox.</p>

<h3>Time to modify phoneserver.pl</h3>

<p>I had to add some code to this Perl script so it showed the incoming calls on
the Squeezebox and that could handle the queries to hitta.se and eniro.se.
Since the calls to those two sites could take some time I decided to call the
Squeezebox twice. First time with the phonenumber (and name if the name is
already known). Next time a couple of seconds later after getting a response
from hitta.se or eniro.se I presented the number and whatever was found. I had
to add a thread to the Perl script which waits for messages meant to go to the
Squeezebox. I wrote the function send_sbmsg for this as below:</p>

<figure class='code'><figcaption><span>Modified phoneserver.pl script </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">sub </span><span class="nf">send_sbmsg</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Thread started\n&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$DEBUG</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$queue</span><span class="o">-&gt;</span><span class="n">dequeue</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1"># Always send firsta message, i.e. phone number only.</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Number only: Popped $msg off the queue\n&quot;</span> <span class="k">if</span> <span class="nv">$DEBUG</span><span class="p">;</span>
</span><span class='line'>        <span class="k">my</span> <span class="nv">$sbmsg</span> <span class="o">=</span> <span class="s">&quot;./sbmsg_short.sh \&quot;$msg\&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;$sbmsg\n&quot;</span> <span class="k">if</span> <span class="nv">$DEBUG</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">system</span><span class="p">(</span><span class="nv">$sbmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">sleep</span> <span class="mi">6</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$semaphore</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">();</span>
</span><span class='line'>        <span class="k">my</span> <span class="nv">$copy_numbersent</span> <span class="o">=</span> <span class="nv">$numbersent</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$semaphore</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Next check if we have name also, then we should resend that.</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$copy_numbersent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$queue</span><span class="o">-&gt;</span><span class="n">dequeue</span><span class="p">();</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;Name also: Popped $msg off the queue\n&quot;</span> <span class="k">if</span> <span class="nv">$DEBUG</span><span class="p">;</span>
</span><span class='line'>            <span class="k">my</span> <span class="nv">$sbmsg</span> <span class="o">=</span> <span class="s">&quot;./sbmsg.sh \&quot;$msg\&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;$sbmsg\n&quot;</span> <span class="k">if</span> <span class="nv">$DEBUG</span><span class="p">;</span>
</span><span class='line'>            <span class="nb">system</span><span class="p">(</span><span class="nv">$sbmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1"># Otherwise, send same message again.</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;Resend Number only: $msg\n&quot;</span> <span class="k">if</span> <span class="nv">$DEBUG</span><span class="p">;</span>
</span><span class='line'>            <span class="k">my</span> <span class="nv">$sbmsg</span> <span class="o">=</span> <span class="s">&quot;./sbmsg.sh \&quot;$msg\&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;$sbmsg\n&quot;</span> <span class="k">if</span> <span class="nv">$DEBUG</span><span class="p">;</span>
</span><span class='line'>            <span class="nb">system</span><span class="p">(</span><span class="nv">$sbmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$semaphore</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$numbersent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$semaphore</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>These are the main changes made to the script. You can download the complete
script here (and don&rsquo;t forget to give Jan credits for the original version):</p>

<p><a href="/nimbox/phoneserver.tar.gz">phoneserver.tar.gz</a> (SHA1: 0c48e94aba48962bc1ad9caa8599b04bd0bcffc3)</p>

<h3>Demonstration</h3>

<p>Below is a video clip showing it in action. I&rsquo;m calling my home number from my
cellular and you can see that my name and number will show up on the
Squeezebox.</p>

<iframe src="//player.vimeo.com/video/11017266" width="500" height="375" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


  
    <footer>
      <p class="meta">
        
        








  


<time datetime="2013-12-22T17:50:00+01:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2013</time>
        
      </p>
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jyx.github.io/nimbox/index.html" data-via="Jyxxan" data-counturl="http://jyx.github.io/nimbox/index.html" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

      
    </footer>
  
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/01/fetchmail-and-gnupg/">Fetchmail and GnuPG</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/02/timing-attack-proof-of-concept/">Timing Attack - Proof of Concept</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/09/apply-patches-in-git/">Apply Patches in Git</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/04/perl-pack-and-unpack/">Perl Pack and Unpack</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/08/05/using-libcurl-with-minimal-dependencies/">Using Libcurl With Minimal Dependencies</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Projects</h1>
  <ul id="projects">
	  <li class='projects'><a href='/bashhelp'>Bash help</a></li>
	  <li class='projects'><a href='/antservo'>Antenna servo</a></li>
	  <li class='projects'><a href='/atschjoo'>ATschjoo</a></li>
	  <li class='projects'><a href='/gengraph'>Gengraph</a></li>
	  <li class='projects'><a href='/globalme'>Global-me</a></li>
	  <li class='projects'><a href='/nimbox'>NIM and Squeezebox</a></li>
	  <li class='projects'><a href='/pakgrep'>Pakgrep</a></li>
	  <li class='projects'><a href='/umlfs'>UML FS</a></li>
	  <li class='projects'><a href='/wolfparser'>Wolfparser</a></li>
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/tools/'>Tools (1)</a></li>
<li class='category'><a href='/blog/categories/c/'>c (1)</a></li>
<li class='category'><a href='/blog/categories/coding/'>coding (6)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (1)</a></li>
<li class='category'><a href='/blog/categories/hacking/'>hacking (2)</a></li>
<li class='category'><a href='/blog/categories/perl/'>perl (1)</a></li>

  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/Jyx">@Jyx</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Jyx',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+JoakimBech?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Joakim Bech -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'joakimbech';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jyx.github.io/nimbox/index.html';
        var disqus_url = 'http://jyx.github.io/nimbox/index.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
